<!DOCTYPE html>
<html lang="ja">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>ã¡ã„ã•ãªãˆã»ã‚“ãƒ¡ãƒ¼ã‚«ãƒ¼ï¼ˆAç‰ˆï¼‹ãŠãˆã‹ããƒ‘ãƒ¬ãƒƒãƒˆï¼‹èƒŒæ™¯è‰²ï¼‰</title>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<style>
/* ====== æœ¨ç›®æœºãƒ»åŸºæœ¬ ====== */
body{
  margin:0;
  background:
    repeating-linear-gradient(90deg,rgba(90,55,20,.06)0 6px,rgba(90,55,20,0)6px 12px),
    repeating-linear-gradient(0deg,rgba(80,48,18,.05)0 8px,rgba(80,48,18,0)8px 12px),
    linear-gradient(0deg,#92693f,#7c5834 30%,#6e4e2f 60%,#7a5733);
  font-family:"M PLUS Rounded 1c",system-ui;
  -webkit-tap-highlight-color: transparent;
}
.palette{
  position:sticky;top:0;z-index:30;display:flex;flex-wrap:wrap;gap:8px;align-items:center;
  margin:6px;padding:8px 12px;border-radius:40px;background:#ffffffdd;backdrop-filter:blur(8px);
  border:1px solid #e8e8e8; box-shadow:0 6px 20px rgba(0,0,0,.15)
}
.btn{appearance:none;border:none;border-radius:99px;padding:8px 14px;font-weight:600;cursor:pointer;background:#fff;box-shadow:0 2px 0 rgba(0,0,0,.1)}
.btn.on{outline:3px solid #92d8ff}
.btn.primary{background:linear-gradient(#ffdede,#ffbbbb)}
.chip{padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #eee}
main{display:flex;gap:12px;padding:12px}
@media(max-width:1000px){ main{flex-direction:column} }
.book-wrap{display:flex;justify-content:center;width:100%;}
.book-stage{position:relative;display:inline-block;padding:26px;border-radius:16px;
  box-shadow:0 30px 40px rgba(0,0,0,.35),0 10px 18px rgba(0,0,0,.18)}
canvas{display:block;touch-action:none}
#bg,#tint,#obj,#paint{position:absolute;left:26px;top:26px}
.side{width:340px;max-width:100%;background:#fff;border-radius:14px;padding:10px;box-shadow:0 6px 20px rgba(0,0,0,.2)}
video,#snap{width:100%;border-radius:12px;background:#000}

/* ã‚¿ãƒ– */
.tabs{display:flex;gap:6px;margin-bottom:6px}
.tab{padding:6px 10px;border-radius:20px;border:1px solid #ddd;background:#fff;font-weight:600}
.tab.active{background:#e7f5ff;border-color:#bfe4ff}
.tab-pane{display:none}
.tab-pane.active{display:block}

/* ã‚¹ãƒŠãƒƒãƒ—ï¼ˆãƒ©ãƒƒã‚½ï¼‰ */
#snap{border:2px dashed #ccc;cursor:crosshair;touch-action:none}

/* ãŠãˆã‹ããƒ‘ãƒãƒ« */
#drawPanel{
  position:sticky;top:72px;z-index:25;
  margin:0 6px 6px;padding:10px 12px;border-radius:14px;
  background:#ffffffee;backdrop-filter:blur(6px);border:1px solid #eee;
  box-shadow:0 8px 18px rgba(0,0,0,.15);display:none
}
#drawPanel.open{display:block}
.row{display:flex;align-items:center;gap:10px;margin:6px 0}
.row label{min-width:5em;color:#333;font-weight:700}

/* ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³èª­ã¿ãã‹ã› */
#fs{position:fixed;inset:0;background:#000;display:none;z-index:200}
#fs.show{display:block}
#fsCanvas{width:100vw;height:100vh;background:#000;touch-action:none}
#fsBtns{position:absolute;left:0;right:0;bottom:20px;display:flex;justify-content:center;gap:12px}
#fsBtns .btn{font-size:18px;padding:10px 16px}
.recLamp{width:10px;height:10px;border-radius:50%;background:#aaa;display:inline-block;margin-left:6px}
.recLamp.on{background:#e53935;box-shadow:0 0 10px #e53935}
</style>

<body>
<!-- ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ -->
<div class="palette">
  <button id="mDraw"  class="btn on">âœï¸ ãŠãˆã‹ã</button>
  <button id="mImg"   class="btn">ğŸ§© ç”»åƒ</button>
  <span class="chip">ğŸ“– <span id="pNow">1</span>/<span id="pAll">1</span></span>
  <button id="pPrev"  class="btn">â—€</button>
  <button id="pNext"  class="btn">â–¶</button>
  <button id="pAdd"   class="btn">ï¼‹è¦‹é–‹ã</button>
  <div style="flex:1"></div>
  <button id="openDrawPanel" class="btn">ğŸ¨ ãŠãˆã‹ãè¨­å®š</button>
  <button id="recStart" class="btn">ğŸ™ éŒ²éŸ³ <span id="lamp" class="recLamp"></span></button>
  <button id="recStop"  class="btn" disabled>â–  åœæ­¢</button>
  <button id="playPage" class="btn">â–¶ å†ç”Ÿ</button>
  <button id="fsOpen"   class="btn">ğŸ“º èª­ã¿ãã‹ã›</button>
  <button id="savePdf"  class="btn primary">ğŸ’¾ PDF</button>
</div>

<!-- ãŠãˆã‹ããƒ‘ãƒ¬ãƒƒãƒˆ -->
<div id="drawPanel">
  <div class="row">
    <label>ãƒšãƒ³è‰²</label>
    <input type="color" id="penColorInput" value="#ff6666">
  </div>
  <div class="row">
    <label>å¤ªã•</label>
    <input type="range" id="penSizeInput" min="2" max="40" value="10">
    <span id="penSizeView">10px</span>
  </div>
  <div class="row">
    <label>æ¶ˆã—ã‚´ãƒ </label>
    <button id="eraserBtn" class="btn">ON/OFF</button>
    <span id="eraserState" style="font-weight:700;color:#e53935">OFF</span>
  </div>
  <div class="row">
    <label>èƒŒæ™¯è‰²</label>
    <input type="color" id="pageBgColor" value="#ffffff">
    <label style="min-width:auto">é€æ˜åº¦</label>
    <input type="range" id="pageBgAlpha" min="0" max="100" value="0">
    <span id="alphaView">0%</span>
  </div>
  <small style="color:#555">èƒŒæ™¯è‰²ã¯è¦‹é–‹ãä¸¡ãƒšãƒ¼ã‚¸ã«æ•·ã‹ã‚Œã¾ã™ï¼ˆç´™ã®è³ªæ„Ÿã®ä¸Šã«åŠé€æ˜ã§é‡ã­ã¾ã™ï¼‰ã€‚</small>
</div>

<main>
  <section class="book-wrap">
    <div id="stage" class="book-stage">
      <canvas id="bg"></canvas>
      <canvas id="tint"></canvas>  <!-- è¿½åŠ ï¼šèƒŒæ™¯è‰²ãƒ¬ã‚¤ãƒ¤ -->
      <canvas id="obj"></canvas>
      <canvas id="paint"></canvas>
    </div>
  </section>

  <aside class="side">
    <div class="tabs">
      <button id="tCam"  class="tab active">ğŸ“· ã‚«ãƒ¡ãƒ©</button>
      <button id="tHelp" class="tab">ï¼Ÿä½¿ã„æ–¹</button>
    </div>
    <div id="camPane" class="tab-pane active">
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">
        <button id="cStart"  class="btn">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
        <button id="cStop"   class="btn" disabled>åœæ­¢</button>
        <button id="cFreeze" class="btn" disabled>ãƒ•ãƒªãƒ¼ã‚º</button>
        <button id="cCut"    class="btn" disabled>åˆ‡ã‚ŠæŠœã</button>
      </div>
      <video id="video" playsinline autoplay muted></video>
      <canvas id="snap" width="0" height="0" title="ãƒ•ãƒªãƒ¼ã‚ºå¾Œã€ä¸€å‘¨ãªãã£ã¦ã­"></canvas>
      <small>æ‰‹é †ï¼šé–‹å§‹â†’ãƒ•ãƒªãƒ¼ã‚ºâ†’ãã‚‹ã£ã¨ä¸€å‘¨â†’åˆ‡ã‚ŠæŠœã</small>
    </div>
    <div id="helpPane" class="tab-pane">
      <small>
        ãƒ»âœï¸ï¼šã‚¯ãƒ¬ãƒ¨ãƒ³ï¼ˆãƒ‘ãƒ¬ãƒƒãƒˆã§è‰²/å¤ªã•/æ¶ˆã—ã‚´ãƒ ï¼‰<br>
        ãƒ»ğŸ§©ï¼šç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼å›è»¢ï¼ˆä¸Šã®â—‹ï¼‰ï¼æ‹¡å¤§ï¼ˆå››éš…â–¡ï¼‰<br>
        ãƒ»èƒŒæ™¯è‰²ï¼šè¦‹é–‹ãå˜ä½ã§è¨­å®šã€PDF/ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«åæ˜ 
      </small>
    </div>
  </aside>
</main>

<!-- ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³èª­ã¿ãã‹ã› -->
<div id="fs">
  <canvas id="fsCanvas"></canvas>
  <div id="fsBtns">
    <button id="fsPrev" class="btn">â—€ å‰</button>
    <button id="fsPlay" class="btn">â–¶ éŸ³å£°</button>
    <button id="fsAuto" class="btn">â¯ è‡ªå‹•å†ç”Ÿ</button>
    <button id="fsNext" class="btn">æ¬¡ â–¶</button>
    <button id="fsExit" class="btn">âŒ é–‰ã˜ã‚‹</button>
  </div>
</div>

<script>
/* ============ å¯¸æ³•ãƒ»ãƒ¬ã‚¤ãƒ¤ ============ */
const PAGE=480, GUT=0, W=PAGE*2, H=PAGE;
const bgCvs  = document.getElementById("bg");
const tintCvs= document.getElementById("tint");   // è¿½åŠ ï¼šèƒŒæ™¯è‰²ãƒ¬ã‚¤ãƒ¤
const objCvs = document.getElementById("obj");
const paintCvs=document.getElementById("paint");
[bgCvs,tintCvs,objCvs,paintCvs].forEach(c=>{c.width=W;c.height=H;});
const stage=document.getElementById("stage");
stage.style.width=(W+52)+"px"; stage.style.height=(H+52)+"px";
const bg = bgCvs.getContext("2d");
const tc = tintCvs.getContext("2d");  // è¿½åŠ ï¼šèƒŒæ™¯è‰²ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
const oc = objCvs.getContext("2d");
const pc = paintCvs.getContext("2d");

/* ============ ç´™èƒŒæ™¯ï¼ˆAãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰ ============ */
let _paper=null;
function paperPat(){
  if(_paper) return _paper;
  const t=document.createElement("canvas");t.width=480;t.height=480;
  const c=t.getContext("2d");
  c.fillStyle="#fbfaf6"; c.fillRect(0,0,480,480);
  for(let i=0;i<520;i++){
    c.fillStyle=`rgba(0,0,0,${(Math.random()*0.05).toFixed(3)})`;
    c.fillRect(Math.random()*480,Math.random()*480,1,1);
  }
  _paper = bg.createPattern(t,'repeat'); return _paper;
}
function rr(ctx,x,y,w,h,r){
  ctx.beginPath(); ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  ctx.closePath();
}
function drawBG(){
  bg.clearRect(0,0,W,H);
  [0,PAGE+GUT].forEach(X=>{
    bg.save(); rr(bg,X,0,PAGE,PAGE,6); bg.clip();
    bg.fillStyle=paperPat(); bg.fillRect(X,0,PAGE,PAGE);
    const g=bg.createLinearGradient(X,0,X+PAGE,0);
    g.addColorStop(0,'rgba(0,0,0,.12)');
    g.addColorStop(.05,'rgba(0,0,0,.04)');
    g.addColorStop(.5,'rgba(0,0,0,0)');
    g.addColorStop(.95,'rgba(0,0,0,.04)');
    g.addColorStop(1,'rgba(0,0,0,.12)');
    bg.globalCompositeOperation='multiply';
    bg.fillStyle=g; bg.fillRect(X,0,PAGE,PAGE);
    bg.restore(); bg.globalCompositeOperation='source-over';
  });
}
drawBG();

/* ============ è¦‹é–‹ããƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆèƒŒæ™¯è‰²ã‚’è¿½åŠ ï¼‰ ============ */
function newSpread(){
  return { paintOff:null, objs:[], audioBlob:null, audioURL:null, tint:{color:'#ffffff', alpha:0} };
}
let spreads=[newSpread()], cur=0;

/* ============ èƒŒæ™¯è‰²ãƒ¬ã‚¤ãƒ¤ï¼ˆtintï¼‰ ============ */
function drawTint(){
  tc.clearRect(0,0,W,H);
  const {color,alpha} = spreads[cur].tint;
  if(!color || alpha<=0) return;
  tc.globalAlpha = Math.max(0, Math.min(1, alpha));
  // å·¦å³ãƒšãƒ¼ã‚¸ã«è§’ä¸¸ã§æ•·ã
  tc.save(); rr(tc,0,0,PAGE,PAGE,6);   tc.clip(); tc.fillStyle=color; tc.fillRect(0,0,PAGE,PAGE);   tc.restore();
  tc.save(); rr(tc,PAGE+GUT,0,PAGE,PAGE,6); tc.clip(); tc.fillStyle=color; tc.fillRect(PAGE+GUT,0,PAGE,PAGE); tc.restore();
  tc.globalAlpha = 1;
}

/* ============ ãƒšãƒ¼ã‚¸ä¿å­˜/èª­è¾¼ ============ */
function saveCur(){
  const off=document.createElement("canvas"); off.width=W; off.height=H;
  off.getContext("2d").drawImage(paintCvs,0,0);
  spreads[cur].paintOff=off;
}
function loadSpread(i){
  cur=i;
  pc.clearRect(0,0,W,H);
  if(spreads[cur].paintOff) pc.drawImage(spreads[cur].paintOff,0,0);
  drawTint();
  redrawObjs();
  updatePageLabel();
}
function updatePageLabel(){ pNow.textContent=cur+1; pAll.textContent=spreads.length; }

/* ============ ã‚¯ãƒ¬ãƒ¨ãƒ³æç”» + ãƒ‘ãƒ¬ãƒƒãƒˆ ============ */
let mode='draw'; mDraw.classList.add('on');
mDraw.onclick=()=>setMode('draw');
mImg.onclick =()=>setMode('edit');
function setMode(m){
  mode=m;
  mDraw.classList.toggle('on', m==='draw');
  mImg.classList.toggle('on',  m==='edit');
  paintCvs.style.pointerEvents = (m==='draw') ? 'auto' : 'none';
  objCvs.style.pointerEvents   = (m==='edit') ? 'auto' : 'none';
}

let isDraw=false, lx=0, ly=0, penColor='#ff6666', penSize=10, erasing=false;
const penColorInput = document.getElementById('penColorInput');
const penSizeInput  = document.getElementById('penSizeInput');
const penSizeView   = document.getElementById('penSizeView');
const eraserBtn     = document.getElementById('eraserBtn');
const eraserState   = document.getElementById('eraserState');
const pageBgColor   = document.getElementById('pageBgColor');
const pageBgAlpha   = document.getElementById('pageBgAlpha');
const alphaView     = document.getElementById('alphaView');

document.getElementById('openDrawPanel').onclick=()=> drawPanel.classList.toggle('open');
penColorInput.oninput = (e)=>{ penColor = e.target.value; erasing=false; updateEraserUI(); };
penSizeInput.oninput  = (e)=>{ penSize = +e.target.value; penSizeView.textContent = penSize+'px'; };
eraserBtn.onclick     = ()=>{ erasing = !erasing; updateEraserUI(); };
function updateEraserUI(){ eraserState.textContent = erasing?'ON':'OFF'; eraserState.style.color = erasing?'#e53935':'#333'; }

pageBgColor.oninput = ()=>{ spreads[cur].tint.color = pageBgColor.value; drawTint(); };
pageBgAlpha.oninput = ()=>{ spreads[cur].tint.alpha = (+pageBgAlpha.value)/100; alphaView.textContent = pageBgAlpha.value+'%'; drawTint(); };

function pos(canvas,e){
  const r=canvas.getBoundingClientRect();
  const cx=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
  const cy=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
  return {x:cx*(canvas.width/r.width), y:cy*(canvas.height/r.height)};
}
function line(x1,y1,x2,y2){
  pc.strokeStyle = erasing ? '#fff' : penColor;
  pc.lineWidth=penSize; pc.lineCap='round'; pc.lineJoin='round';
  pc.beginPath(); pc.moveTo(x1,y1); pc.lineTo(x2,y2); pc.stroke();
}
function dStart(e){ if(mode!=='draw')return; isDraw=true; const p=pos(paintCvs,e); lx=p.x; ly=p.y; e.preventDefault(); }
function dMove(e){ if(!isDraw||mode!=='draw')return; const p=pos(paintCvs,e); line(lx,ly,p.x,p.y); lx=p.x; ly=p.y; e.preventDefault(); }
function dEnd(){ isDraw=false; }
paintCvs.addEventListener('mousedown',dStart); paintCvs.addEventListener('mousemove',dMove); paintCvs.addEventListener('mouseup',dEnd);
paintCvs.addEventListener('touchstart',dStart,{passive:false}); paintCvs.addEventListener('touchmove',dMove,{passive:false}); paintCvs.addEventListener('touchend',dEnd);

/* ============ ç”»åƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆç§»å‹•ãƒ»å›è»¢ãƒ»æ‹¡å¤§ï¼‰ ============ */
function redrawObjs(){
  oc.clearRect(0,0,W,H);
  spreads[cur].objs.forEach((o,i)=>{
    oc.save(); oc.translate(o.cx,o.cy); oc.rotate(o.theta); oc.scale(o.scale,o.scale);
    oc.drawImage(o.img, -o.w/2, -o.h/2);
    oc.restore();
    if(i===sel && mode==='edit') drawGizmo(o);
  });
}
function drawGizmo(o){
  const hw=o.w*o.scale/2, hh=o.h*o.scale/2, a=o.theta;
  const rot=(p)=>({x:o.cx+p.x*Math.cos(a)-p.y*Math.sin(a), y:o.cy+p.x*Math.sin(a)+p.y*Math.cos(a)});
  const c=[{x:-hw,y:-hh},{x:hw,y:-hh},{x:hw,y:hh},{x:-hw,y:hh}].map(rot);
  oc.save();
  oc.strokeStyle='#2b7bff'; oc.lineWidth=2; oc.setLineDash([8,6]);
  oc.beginPath(); oc.moveTo(c[0].x,c[0].y); for(let i=1;i<4;i++) oc.lineTo(c[i].x,c[i].y); oc.closePath(); oc.stroke(); oc.setLineDash([]);
  c.forEach(p=>{ oc.fillStyle='#fff'; oc.beginPath(); oc.rect(p.x-6,p.y-6,12,12); oc.fill(); oc.stroke(); });
  const topMid={x:(c[0].x+c[1].x)/2, y:(c[0].y+c[1].y)/2};
  const hx=topMid.x+Math.cos(o.theta-Math.PI/2)*30, hy=topMid.y+Math.sin(o.theta-Math.PI/2)*30;
  oc.beginPath(); oc.moveTo(topMid.x,topMid.y); oc.lineTo(hx,hy); oc.stroke();
  oc.beginPath(); oc.arc(hx,hy,8,0,Math.PI*2); oc.fill(); oc.stroke();
  oc.restore();
}
function local(o,px,py){
  const dx=px-o.cx, dy=py-o.cy, c=Math.cos(-o.theta), s=Math.sin(-o.theta);
  return {x:(dx*c-dy*s)/o.scale, y:(dx*s+dy*c)/o.scale};
}
function hitCorner(o,px,py){
  const p=local(o,px,py), m=10/o.scale, hw=o.w/2, hh=o.h/2;
  if(Math.abs(p.x-hw)<m&&Math.abs(p.y-hh)<m) return 2;
  if(Math.abs(p.x+hw)<m&&Math.abs(p.y-hh)<m) return 3;
  if(Math.abs(p.x+hw)<m&&Math.abs(p.y+hh)<m) return 0;
  if(Math.abs(p.x-hw)<m&&Math.abs(p.y+hh)<m) return 1;
  return -1;
}
function hitRotate(o,px,py){
  const hw=o.w*o.scale/2, a=o.theta;
  const topMid={x:o.cx+Math.cos(a)*hw, y:o.cy+Math.sin(a)*hw};
  const hx=topMid.x+Math.cos(o.theta-Math.PI/2)*30, hy=topMid.y+Math.sin(o.theta-Math.PI/2)*30;
  return Math.hypot(px-hx,py-hy)<12;
}
let sel=-1, action=null, dragOff={x:0,y:0}, rotStart={ang:0,theta:0}, scaleStart={d:0,s:1};
objCvs.addEventListener('mousedown', oDown); objCvs.addEventListener('mousemove', oMove); objCvs.addEventListener('mouseup', oUp);
objCvs.addEventListener('touchstart', oDown,{passive:false}); objCvs.addEventListener('touchmove', oMove,{passive:false}); objCvs.addEventListener('touchend', oUp);
function oDown(e){
  if(mode!=='edit') return;
  const p=pos(objCvs,e);
  sel=-1;
  for(let i=spreads[cur].objs.length-1;i>=0;i--){
    const o=spreads[cur].objs[i], lp=local(o,p.x,p.y);
    if(Math.abs(lp.x)<=o.w/2 && Math.abs(lp.y)<=o.h/2){ sel=i; break; }
  }
  if(sel<0) return;
  const o=spreads[cur].objs[sel];
  if(hitRotate(o,p.x,p.y)){ action='rotate'; rotStart.ang=Math.atan2(p.y-o.cy,p.x-o.cx); rotStart.theta=o.theta; }
  else{
    const c=hitCorner(o,p.x,p.y);
    if(c>=0){ action='scale'; scaleStart.d=Math.hypot(p.x-o.cx,p.y-o.cy); scaleStart.s=o.scale; }
    else{ action='move'; dragOff.x=p.x-o.cx; dragOff.y=p.y-o.cy; }
  }
  e.preventDefault();
}
function oMove(e){
  if(mode!=='edit' || sel<0 || !action) return;
  const p=pos(objCvs,e), o=spreads[cur].objs[sel];
  if(action==='move'){ o.cx=p.x-dragOff.x; o.cy=p.y-dragOff.y; }
  else if(action==='scale'){ const d=Math.hypot(p.x-o.cx,p.y-o.cy); o.scale=Math.max(0.05,Math.min(10, scaleStart.s*d/Math.max(1,scaleStart.d))); }
  else if(action==='rotate'){ let d=Math.atan2(p.y-o.cy,p.x-o.cx)-rotStart.ang; if(e.shiftKey){ const step=Math.PI/12; d=Math.round(d/step)*step; } o.theta=rotStart.theta+d; }
  redrawObjs(); e.preventDefault();
}
function oUp(){ action=null; }

/* ============ ã‚«ãƒ¡ãƒ©è‡ªç”±åˆ‡ã‚ŠæŠœãï¼ˆiPadå¯¾å¿œï¼‰ ============ */
const video=document.getElementById("video"), snap=document.getElementById("snap"), sctx=snap.getContext("2d");
const cStart=document.getElementById("cStart"), cStop=document.getElementById("cStop"), cFreeze=document.getElementById("cFreeze"), cCut=document.getElementById("cCut");
let stream=null, snapImg=null, lasso=[], lassoOn=false;
function setCamBtns(running, frozen){ cStart.disabled=running; cStop.disabled=!running; cFreeze.disabled=!running; cCut.disabled=!(frozen && lasso.length>5); }
setCamBtns(false,false);
cStart.onclick=async()=>{ try{stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}); video.srcObject=stream; setCamBtns(true,false);}catch(e){alert('ã‚«ãƒ¡ãƒ©æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„\n'+e);} };
cStop.onclick =()=>{ stream?.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; snapImg=null; snap.width=0; snap.height=0; lasso=[]; lassoOn=false; setCamBtns(false,false); };
cFreeze.onclick=async()=>{
  if(!video.videoWidth){alert('æº–å‚™ä¸­ã§ã™');return;}
  if(window.createImageBitmap){ snapImg=await createImageBitmap(video); }
  else{ const t=document.createElement('canvas'); t.width=video.videoWidth; t.height=video.videoHeight; t.getContext('2d').drawImage(video,0,0); snapImg=new Image(); snapImg.src=t.toDataURL(); await snapImg.decode(); }
  snap.width=snapImg.width; snap.height=snapImg.height; lasso=[]; lassoOn=false; renderSnap(); snap.style.width="100%"; snap.style.height="auto"; setCamBtns(true,true);
};
function sPos(e){
  const r=snap.getBoundingClientRect();
  const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
  const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
  return {x:x*(snap.width/r.width), y:y*(snap.height/r.height)};
}
function renderSnap(){
  if(!snapImg) return;
  sctx.clearRect(0,0,snap.width,snap.height);
  sctx.drawImage(snapImg,0,0);
  if(lasso.length>1){
    sctx.save();
    sctx.fillStyle='rgba(0,0,0,.25)'; sctx.fillRect(0,0,snap.width,snap.height);
    sctx.globalCompositeOperation='destination-out';
    sctx.beginPath(); sctx.moveTo(lasso[0].x,lasso[0].y);
    for(let i=1;i<lasso.length;i++) sctx.lineTo(lasso[i].x,lasso[i].y);
    if(!lassoOn) sctx.closePath();
    sctx.fill();
    sctx.restore();

    sctx.strokeStyle='#00aaff'; sctx.lineWidth=2; sctx.setLineDash([8,6]);
    sctx.beginPath(); sctx.moveTo(lasso[0].x,lasso[0].y);
    for(let i=1;i<lasso.length;i++) sctx.lineTo(lasso[i].x,lasso[i].y);
    if(!lassoOn) sctx.closePath();
    sctx.stroke(); sctx.setLineDash([]);
  }
}
function sDown(e){ if(!snapImg) return; lasso=[sPos(e)]; lassoOn=true; renderSnap(); e.preventDefault(); }
function sMove(e){ if(!lassoOn) return; const p=sPos(e); const last=lasso[lasso.length-1]; if(!last||Math.hypot(p.x-last.x,p.y-last.y)>2){ lasso.push(p); renderSnap(); } e.preventDefault(); }
function sUp(){ if(!lassoOn) return; lassoOn=false; setCamBtns(true,true); renderSnap(); }
['mousedown','touchstart'].forEach(ev=> snap.addEventListener(ev, sDown, {passive:false}));
['mousemove','touchmove' ].forEach(ev=> snap.addEventListener(ev, sMove, {passive:false}));
['mouseup','mouseleave','touchend'].forEach(ev=> snap.addEventListener(ev, sUp));
cCut.onclick=()=>{
  if(!snapImg || lasso.length<3){ alert('è‡ªç”±ç·šã§ä¸€å‘¨ãªãã£ã¦ãã ã•ã„'); return; }
  let minX=Infinity,minY=Infinity,maxX=-Infinity,maxY=-Infinity;
  for(const p of lasso){ if(p.x<minX)minX=p.x; if(p.y<minY)minY=p.y; if(p.x>maxX)maxX=p.x; if(p.y>maxY)maxY=p.y; }
  const w=Math.max(1,Math.ceil(maxX-minX)), h=Math.max(1,Math.ceil(maxY-minY));
  const off=document.createElement('canvas'); off.width=w; off.height=h; const octx=off.getContext('2d');
  octx.drawImage(snapImg,minX,minY,w,h,0,0,w,h);
  octx.globalCompositeOperation='destination-in';
  octx.beginPath(); octx.moveTo(lasso[0].x-minX,lasso[0].y-minY);
  for(let i=1;i<lasso.length;i++) octx.lineTo(lasso[i].x-minX,lasso[i].y-minY);
  octx.closePath(); octx.fill();
  spreads[cur].objs.push({ img:off, w:off.width, h:off.height, cx:W/2, cy:H/2, scale:1, theta:0 });
  sel = spreads[cur].objs.length-1; setMode('edit'); redrawObjs(); alert('è²¼ã‚Šä»˜ã‘ã¾ã—ãŸã€‚ğŸ§©ã§å‹•ã‹ã›ã¾ã™');
};

/* ============ ã‚¿ãƒ–åˆ‡æ›¿ ============ */
tCam.onclick = ()=>{ tCam.classList.add('active'); tHelp.classList.remove('active'); camPane.classList.add('active'); helpPane.classList.remove('active'); }
tHelp.onclick= ()=>{ tHelp.classList.add('active'); tCam.classList.remove('active'); helpPane.classList.add('active'); camPane.classList.remove('active'); }

/* ============ ãƒšãƒ¼ã‚¸åˆ¶å¾¡ ============ */
pAdd.onclick = ()=>{ saveCur(); spreads.push(newSpread()); loadSpread(spreads.length-1); };
pPrev.onclick= ()=>{ if(cur>0){ saveCur(); loadSpread(cur-1); } };
pNext.onclick= ()=>{ if(cur<spreads.length-1){ saveCur(); loadSpread(cur+1); } };
updatePageLabel();

/* ============ ãƒšãƒ¼ã‚¸éŒ²éŸ³ï¼ˆMediaRecorderï¼‰ ============ */
const lamp=document.getElementById('lamp'); let mediaRecorder=null, chunks=[];
recStart.onclick=async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRecorder=new MediaRecorder(stream);
    chunks=[];
    mediaRecorder.ondataavailable=(e)=>{ if(e.data.size>0) chunks.push(e.data); };
    mediaRecorder.onstop=()=>{
      const blob=new Blob(chunks,{type:'audio/webm'});
      spreads[cur].audioBlob=blob;
      spreads[cur].audioURL = URL.createObjectURL(blob);
      lamp.classList.remove('on'); recStop.disabled=true; recStart.disabled=false;
      alert('ã“ã®ãƒšãƒ¼ã‚¸ã®éŸ³å£°ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    };
    mediaRecorder.start();
    lamp.classList.add('on'); recStart.disabled=true; recStop.disabled=false;
  }catch(e){ alert('ãƒã‚¤ã‚¯æ¨©é™ã‚’è¨±å¯ã—ã¦ãã ã•ã„\n'+e); }
};
recStop.onclick=()=>{ if(mediaRecorder && mediaRecorder.state!=='inactive'){ mediaRecorder.stop(); } };
playPage.onclick=()=>{ const url=spreads[cur].audioURL; if(!url){alert('ã“ã®ãƒšãƒ¼ã‚¸ã«éŸ³å£°ã¯ã‚ã‚Šã¾ã›ã‚“');return;} new Audio(url).play(); };

/* ============ ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³èª­ã¿ãã‹ã› ============ */
/* ============ ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³èª­ã¿ãã‹ã›ï¼ˆãƒšãƒ¼ã‚¸ã”ã¨éŸ³å£°å¯¾å¿œï¼‰ ============ */
const fs=document.getElementById('fs');
const fsCanvas=document.getElementById('fsCanvas');
const fsCtx=fsCanvas.getContext('2d');
let autoPlaying = false;
let currentAudio = null;

function fitFS(){
  fsCanvas.width = window.innerWidth;
  fsCanvas.height= window.innerHeight;
}

function drawFS(){
  fsCtx.fillStyle='#000';
  fsCtx.fillRect(0,0,fsCanvas.width,fsCanvas.height);

  const comp=document.createElement("canvas");
  comp.width=W; comp.height=H;
  const cc=comp.getContext("2d");

  // ç´™èƒŒæ™¯
  drawBG(); cc.drawImage(bgCvs,0,0);

  // èƒŒæ™¯è‰²
  const {color,alpha} = spreads[cur].tint;
  if(alpha>0){
    cc.save(); cc.globalAlpha=alpha;
    rr(cc,0,0,PAGE,PAGE,6); cc.clip(); cc.fillStyle=color; cc.fillRect(0,0,PAGE,PAGE); cc.restore();
    cc.save(); cc.globalAlpha=alpha;
    rr(cc,PAGE,0,PAGE,PAGE,6); cc.clip(); cc.fillStyle=color; cc.fillRect(PAGE,0,PAGE,PAGE); cc.restore();
  }

  // ç”»åƒ
  spreads[cur].objs.forEach(o=>{
    cc.save(); cc.translate(o.cx,o.cy); cc.rotate(o.theta); cc.scale(o.scale,o.scale);
    cc.drawImage(o.img,-o.w/2,-o.h/2);
    cc.restore();
  });

  // æ‰‹æã
  if(spreads[cur].paintOff) cc.drawImage(spreads[cur].paintOff,0,0);
  else cc.drawImage(paintCvs,0,0);

  // fit
  const scale=Math.min(fsCanvas.width/W, fsCanvas.height/H);
  const dx=(fsCanvas.width - W*scale)/2;
  const dy=(fsCanvas.height - H*scale)/2;

  fsCtx.save();
  fsCtx.translate(dx,dy);
  fsCtx.scale(scale,scale);
  fsCtx.drawImage(comp,0,0);
  fsCtx.restore();
}

function playCurrentPageAudio(){
  stopCurrentAudio();
  const url = spreads[cur].audioURL;
  if(!url) return null;
  currentAudio = new Audio(url);
  currentAudio.play();
  return currentAudio;
}

function stopCurrentAudio(){
  if(currentAudio){
    currentAudio.pause();
    currentAudio = null;
  }
}

function fsGoToPage(i){
  saveCur();
  loadSpread(i);
  drawFS();
}

function nextPageFS(){
  if(cur < spreads.length-1){
    fsGoToPage(cur+1);
    playCurrentPageAudio();
  } else {
    stopAutoPlay();
  }
}

function prevPageFS(){
  if(cur > 0){
    fsGoToPage(cur-1);
    playCurrentPageAudio();
  }
}

/* ===== ãƒœã‚¿ãƒ³å‹•ä½œ ===== */
fsPrev.onclick = ()=>{ prevPageFS(); };
fsNext.onclick = ()=>{ nextPageFS(); };
fsPlay.onclick = ()=>{ playCurrentPageAudio(); };

/* ===== è‡ªå‹•å†ç”Ÿ ===== */
function startAutoPlay(){
  autoPlaying = true;
  autoPlayPage();
}

function autoPlayPage(){
  const a = playCurrentPageAudio();
  if(!a){
    nextPageFS();
    return;
  }
  a.onended = ()=> nextPageFS();
}

function stopAutoPlay(){
  autoPlaying = false;
  stopCurrentAudio();
}

fsAuto.onclick = ()=>{
  if(autoPlaying){
    stopAutoPlay();
  } else {
    startAutoPlay();
  }
};

function openFS(){
  fs.classList.add('show');
  if(document.documentElement.requestFullscreen){ document.documentElement.requestFullscreen().catch(()=>{}); }
  fitFS(); drawFS();
  playCurrentPageAudio(); // é–‹ã„ãŸã‚‰ãã®ãƒšãƒ¼ã‚¸ã®éŸ³
}

function closeFS(){
  fs.classList.remove('show');
  stopAutoPlay();
  if(document.fullscreenElement){ document.exitFullscreen().catch(()=>{}); }
}

fsOpen.onclick=openFS;
fsExit.onclick=closeFS;

window.addEventListener('resize', ()=>{ if(fs.classList.contains('show')){ fitFS(); drawFS(); } });


/* ============ PDF ä¿å­˜ï¼ˆèƒŒæ™¯è‰²ã‚‚åæ˜ ï¼‰ ============ */
savePdf.onclick=()=>{
  saveCur();
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF({orientation:'landscape',unit:'px',format:[W,H]});
  spreads.forEach((sp,i)=>{
    const c=document.createElement('canvas'); c.width=W; c.height=H; const cx=c.getContext('2d');

    // ç´™
    drawBG(); cx.drawImage(bgCvs,0,0);
    // èƒŒæ™¯è‰²
    if(sp.tint && sp.tint.alpha>0){
      cx.save(); cx.globalAlpha=Math.max(0,Math.min(1,sp.tint.alpha));
      rr(cx,0,0,PAGE,PAGE,6); cx.clip(); cx.fillStyle=sp.tint.color; cx.fillRect(0,0,PAGE,PAGE); cx.restore();
      cx.save(); cx.globalAlpha=Math.max(0,Math.min(1,sp.tint.alpha));
      rr(cx,PAGE+GUT,0,PAGE,PAGE,6); cx.clip(); cx.fillStyle=sp.tint.color; cx.fillRect(PAGE+GUT,0,PAGE,PAGE); cx.restore();
    }
    // ç”»åƒ
    sp.objs.forEach(o=>{ cx.save(); cx.translate(o.cx,o.cy); cx.rotate(o.theta); cx.scale(o.scale,o.scale); cx.drawImage(o.img,-o.w/2,-o.h/2); cx.restore(); });
    // ç·š
    if(sp.paintOff) cx.drawImage(sp.paintOff,0,0); else cx.drawImage(paintCvs,0,0);

    pdf.addImage(c.toDataURL('image/png'),'PNG',0,0,W,H);
    if(i<spreads.length-1) pdf.addPage([W,H],'landscape');
  });
  pdf.save('ehon.pdf');
};
</script>
</body>
</html>
